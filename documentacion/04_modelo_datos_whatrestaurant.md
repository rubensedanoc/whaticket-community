# 04_Modelo_Datos_whatrestaurant

#### Consideraciones inicales

- Esta base de datos junto todo el codigo, fue heredado del repositorio original del cual se hizo el fork, asi que varias cosas, algunas basicas, se fueron agregando rapidamente al inicio y no dependieron de parte de Restaurant.pe
- Se van a obviar columnas de propósito obvio en es guia. Ejem: id, created_at, updated_at...
- Se van a obviar tablas basicas que no necesitan mucha explicacion para entender el trasnfondo

## Tablas principales

### Messages

| Columna        | Tipo            | Descripción                                                                              | Comentario                                                                                                                                                                                                                     |
| -------------- | --------------- | ---------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `id`           | PK varchar(255) | id unico que devuelve wpp por mensaje                                                    | Este id solo lo generamos nosotros cuando queremos guardar un mensaje duplicado en la bd, se usa en conjunto con la columna `isDuplicated`                                                                                     |
| `body`         | text            | Cuerpo del mensaje de wpp                                                                |
| `ack`          | int(11)         | Estado del mensaje de wpp (enviando, enviado, recibido y entregado)                      | Usado para mostrar el estado del mensaje en el front                                                                                                                                                                           |
| `read`         | varchar         | Hash seguro de la contraseña                                                             | Pocamente usado, más se usa la columna ack                                                                                                                                                                                     |
| `mediaType`    | varchar(255)    | tipo de mensaje, puede des texto plano o con archivo multimedia                          |
| `mediaUrl`     | varchar(255)    | ubicacion del contenido multimedia relacionado al mensaje                                | Este se guarda en la carpeta public del poyecto                                                                                                                                                                                |
| `ticketId`     | FK int(11)      | Llave foranea que relaciona con la tabla Tickets                                         | Ticket al que pertenece el mensaje                                                                                                                                                                                             |
| `fromMe`       | tinyint(1)      | Booleano que indica si el mensaje fue enviado por la conexion o por un externo           |
| `isDeleted`    | tinyint(1)      | Booleano que indica si el mensaje fue borrado en wpp                                     |
| `contactId`    | FK int(11)      | Llave foranea que relaciona con la tabla Contacts                                        |
| `quotedMsgId`  | varchar(255)    | Llave foranea que relaciona con la tabla Mensajes                                        | Este es para vincular un mensaje con otro cuando responden mensajes                                                                                                                                                            |
| `isPrivate`    | tinyint(1)      | Booleano que indica si el mensaje en realidad es una nota interna escrita por un usuario |                                                                                                                                                                                                                                |
| `timestamp`    | int(11)         | timestamp que devuelve wpp de cuando se creó un mensaje                                  | IMPORTANTE: Todos deberian de tenerla pero la bd original no lo consideraba                                                                                                                                                    |
| `isDuplicated` | tinyint(1)      | Booleano que indica si el mensaje es duplicado                                           | IMPORTANTE: Esto pasa cuando hay 2 conexiones en un mismo grupo, wpp devuelve 2 veces el mismo mensaje con el mismo id y la bd lo rechaza y se se genera uno nuevo para poder guardarlo, indicando que el mensaje es duplicado |
| `isEdited`     | int(11)         | timestamp que devuelve wpp de cuando se creó un mensaje                                  |                                                                                                                                                                                                                                |
| `identifier`   | varchar(255)    | identificador usado para flujos de chatbot                                               | Revisar codigo para más detalle                                                                                                                                                                                                |

### Whatsapps

| Columna           | Tipo           | Descripción                                                          | Comentario                                                                                                                                                                                                                   |
| ----------------- | -------------- | -------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `session`         | text           | Columna sin usar que vino en la bd original                          |                                                                                                                                                                                                                              |
| `qrcode`          | text           | qr disponible para conectar la conexion                              | Solo tiene data si la conexion esta en estado qrcode                                                                                                                                                                         |
| `status`          | varchar(255)   | Estado de la conexion qrcode, CONNECTED, DISCONNECTED                | Este se actualiza escuchando los eventos de wwebjs                                                                                                                                                                           |
| `read`            | varchar        | Hash seguro de la contraseña                                         | Pocamente usado, más se usa la columna ack                                                                                                                                                                                   |
| `battery`         | varchar(255)   | Columna sin usar que vino en la bd original                          |
| `plugged`         | tinyint(1)     | Columna sin usar que vino en la bd original                          |                                                                                                                                                                                                                              |
| `name`            | K varchar(255) | Nombre de la conexion                                                |
| `isDefault`       | tinyint(1)     | Marca si la conexion es la por defecto                               | Esto lo usan en casos que no saben que conexion usar para x cosa siempre buscan esa                                                                                                                                          |
| `retries`         | int(11)        | Columna sin usar que vino en la bd original                          |
| `greetingMessage` | text           | Mensaje de bienvenida para nuevos tickets de esta conexion           | Validar en codigo en que casos se utiliza ya que se alterna con el de queue (departamento)                                                                                                                                   |
| `farewellMessage` | text           | Mensaje de despedida que se manda al cerrar tickets de esta conexion | Los usuario en front eligen si mandarlo o no                                                                                                                                                                                 |
| `number`          | varchar(255)   | Número real de la conexion                                           | Este se actualiza cada vez que la conexion se conecta                                                                                                                                                                        |
| `webhook`         | varchar(255)   | Url a la cual reenvia todos los mensajes que van llegando            |                                                                                                                                                                                                                              |
| `sessionUuid`     | varchar(255)   | uuid usado para cambiar de carpeta de credenciales de wwebjs         | IMPORTANTE: Esto se usa cuando se reinicia a la fuerza una conexion, basicamente se cambia el uuid de la conexion y se inicia un wbot con ese uuid, uuid es solo el nombre de la carpeta en donde el wpp guarda credenciales |
| `phoneToNotify`   | text           | Número al cual notificar que hubo un problema con la conexion        | Actualmente esa funcionalidad ya no se utiliza                                                                                                                                                                               |
| `wasDeleted`      | tinyint(1)     | Booleano que indica si la conexion esta marcada como eliminada       | Como un Estado 0                                                                                                                                                                                                             |
| `countryId`       | FK int(11)     | Llave foranea que relaciona con la tabla Countries                   | IMPORTANTE: Ya no se utiliza, ahora se utiliza una tabla de muchos a muchos WhatsappCountries                                                                                                                                |

### Tickets

| Columna                                | Tipo         | Descripción                                                                             | Comentario                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| -------------------------------------- | ------------ | --------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `status`                               | varchar(255) | Estado del ticket: open, closed, pending                                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `lastMessage`                          | text         | El body del ultimo mensaje del ticket                                                   | No necesariamente podria ser el utlimo, puede haber fallas                                                                                                                                                                                                                                                                                                                                                                                                      |
| `contactId `                           | FK int(11)   | Llave foranea que relaciona con la tabla Contacts                                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `userId`                               | FK int(11)   | Llave foranea que relaciona con la tabla Users                                          | Es el id del usuario asignado al ticket                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `whatsappId`                           | FK int(11)   | Llave foranea que relaciona con la tabla Whatsapps                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `isGroup`                              | tinyint(1)   | Booleano que indica si el ticket pertecene a un contacto grupal                         | los chats grupales en whaticket se tratan como contactos                                                                                                                                                                                                                                                                                                                                                                                                        |
| `unreadMessages`                       | int(11)      | Numero de mensajes sin leer                                                             | Este numero no puede ser tan exacto ya que se actualiza en los eventos de wpp dependiendo del codigo                                                                                                                                                                                                                                                                                                                                                            |
| `queueId`                              | FK int(11)   | Llave foranea que relaciona con la tabla Queues                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `privateNote`                          | varchar(255) | Columna sin usar que se creo antes de los mensages privados                             | Por ahi la trate de usar para un chatbot pero si no me equivoco no lo usan o no esta funcional                                                                                                                                                                                                                                                                                                                                                                  |
| `userHadContact`                       | tinyint(1)   | Booleano que indica si un usuario de whaticket ya tuvo contacto con el ticket           | Ultimamente no se ha estado consideranco mucho, igualmente revisar codigo                                                                                                                                                                                                                                                                                                                                                                                       |
| `lastMessageTimestamp`                 | int(11)      | Timestamp del ultimo mensaje del ticket                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `transferred`                          | tinyint(1)   | Booleano que indica si el ticket ha sido transferido al menos una vez                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `chatbotMessageIdentifier`             | varchar(255) | Identificador para el flujo de chatbot                                                  | Nunca se llego a utilizar por completo, actualmente sin uso                                                                                                                                                                                                                                                                                                                                                                                                     |
| `chatbotMessageLastStep`               | varchar(255) | Identificador de ultimo paso para el flujo de chatbot                                   | Nunca se llego a utilizar por completo, actualmente sin uso                                                                                                                                                                                                                                                                                                                                                                                                     |
| `categorizedByAI`                      | tinyint(1)   | Booleano que indica si el ticket ha sido categorizado por ia                            | Antes los tickets del departamento de customer succes se categorizaban con ia, hasta que empezaron a cambiar muchas cuentas de openai entonces se perdia ese categorizado que se hacia usando finetunning, si en algun momento quieren volver a reactivarlo para el area de CS, revisar la carpeta openai, ahi hay un jsonl para volver a recrear el finetuning con las creednciales actuales de openai, en server.ts del backend esta el cron que categorizaba |
| `marketingCampaignId`                  | FK int(11)   | Llave foranea que relaciona con la tabla MarketingCampaign                              | IMPORTANTE: Esto es para whaticketComercial y si se usa mucho                                                                                                                                                                                                                                                                                                                                                                                                   |
| `wasSentToZapier`                      | tinyint(1)   | Booleano que indica si el ticket fue enviado a un sistema de automatizacion de procesos | Se llama Zapier pero utilizan n8n                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `beenWaitingSinceTimestamp`            | int(11)      | Tiempo que el cliente lleva esperando en unixtimestamp (segundos)                       | Se calcula en varias ocasiones si no me equivoco, hay un metodo centralizado que hace eso                                                                                                                                                                                                                                                                                                                                                                       |
| `messagingCampaignId`                  | FK int(11)   | Llave foranea que relaciona con la tabla MessagingCampaigns                             | Funcional pero nunca se llego a utilizar en produccion para el proyecto de general                                                                                                                                                                                                                                                                                                                                                                              |
| `messagingCampaignShipmentId`          | FK int(11)   | Llave foranea que relaciona con la tabla MessagingCampaignShipments                     | Funcional pero nunca se llego a utilizar en produccion para el proyecto de general                                                                                                                                                                                                                                                                                                                                                                              |
| `marketingMessagingCampaignId`         | FK int(11)   | Llave foranea que relaciona con la tabla MarketingMessagingCampaigns                    | IMPORTANTE: Esto es para whaticketComercial y si se usa mucho, ya que marketing manda muchas campañas                                                                                                                                                                                                                                                                                                                                                           |
| `marketingMessagingCampaignShipmentId` | FK int(11)   | Llave foranea que relaciona con la tabla MarketingMessagingCampaignShipments            | IMPORTANTE: Esto es para whaticketComercial y si se usa mucho, ya que marketing manda muchas campañas                                                                                                                                                                                                                                                                                                                                                           |

### Queues (Departamentos)

| Columna                              | Tipo         | Descripción                                                                                    | Comentario                                                                                                                      |
| ------------------------------------ | ------------ | ---------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------- |
| `name`                               | varchar(255) | Nombre del departamento                                                                        |
| `color`                              | varchar(255) | Color del departamento                                                                         |
| `greetingMessage`                    | text         | Mensaje de bienvenida para nuevos tickets de este departamento                                 | Revisar en codigo el flujo actal ya que en determinados casos, este mensaje de bienvenido o el del wpp                          |
| `automaticAssignment`                | tinyint(1)   | Si el departamento va a signar tickets a usuarios automaticamente                              | Nadie la usa al momento                                                                                                         |
| `automaticAssignmentForOfflineUsers` | tinyint(1)   | Si durante la asignacion automatica de usuarios se va a considerar los usuarios fuera de linea | Nadie la usa al momento                                                                                                         |
| `categorizeTicketsWithAI`            | tinyint(1)   | Si el departamento va a categorizar tickets con ia                                             | Se usaba antes ahorita esta en stand by pq cada vez que cambiaban cuenta de openai, se tenia que hacer otra vez el fine tunning |
| `categorizationOpenAIModel`          | varchar(255) | Modelo de categorizacion de openai para la categorizacion automatica de tickets                | Se usaba antes ahorita esta en stand by pq cada vez que cambiaban cuenta de openai, se tenia que hacer otra vez el fine tunning |
| `defaultTicketCategoryId`            | int(11)      | Categoria por defecto al abrir un ticket de este departamento                                  | Se usa para el proyecto comercial peor si es funcional para los 2                                                               |

### Contacts (Departamentos)

| Columna                                | Tipo         | Descripción                                                                                 | Comentario                                                                                                                                                                                                                                                                                                                                                              |
| -------------------------------------- | ------------ | ------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `name`                                 | varchar(255) | Nombre del contacto                                                                         | Wpp te devuelve un nombre de contacto si es que este tiene en wpp, sino te va a devolver como nombre el numero del contacto como tal. De igual manera se puede editar                                                                                                                                                                                                   |
| `number`                               | varchar(255) | Numero del contacto                                                                         | Número del contacto con prefijo. IMPORTANTE: Por politicas de privacidad hay algunos contactos que wpp te devuelve con un identificador interno en vez que el numero de vrd, por eso veras contactos con numeros raros, esto pasa más en grupos como tal, tienes que tener eso en cuenta, a medida que ha ido avanzado la libreria han intentado mejorar eso peor igual |
| `profilePicUrl`                        | varchar(255) | Url de la foto de wpp del contacto                                                          | Url de los servidores de wpp para obtener la foto del contacto                                                                                                                                                                                                                                                                                                          |
| `email`                                | varchar(255) | Email del contacto                                                                          | Vino con la bd original casi no se usa                                                                                                                                                                                                                                                                                                                                  |
| `isGroup`                              | tinyint(1)   | Booleano que indica si el contacto es un grupo                                              | los chats grupales, son en realidad conversacion con un contacto de tipo grupal                                                                                                                                                                                                                                                                                         |
| `domain`                               | varchar(255) | Dominio del contacto                                                                        | Se agregó al principio para que los usuarios puedan guardar el nombre de un dominio manualmente. Actualmente se hace una request a microservice para mostrar esa data a los usuario, y ellos son los encargados de vincularlos en microservice                                                                                                                          |
| `isCompanyMember`                      | tinyint(1)   | Booleano que indica si el contacto esta relacionado a la empresa                            | Esto se utiliza bastante en reportes para no contar tickets de esos contactos y tmb se nota visualmente en los chats                                                                                                                                                                                                                                                    |
| `countryId`                            | FK int(11)   | Llave foranea que relaciona con la tabla Countries                                          | Se determina el pais por la extension del numero del contacto                                                                                                                                                                                                                                                                                                           |
| `isExclusive`                          | tinyint(1)   | Booleano que indica si el contacto esta relacionado a un dominio importante en microservice | Whaticket sincroniza este dato cada cierto tiempo a través de un cron                                                                                                                                                                                                                                                                                                   |
| `traza_clientelicencia_id`             | int(11)      | El clientelicencia_id de trazabilidad relacionado a ese contacto                            | IMPORTANTE: Ya no se utiliza, Este campo los usuarios lo ponian manualmente editando el contacto o desde un ticket con ese contacto. Ahora se utiliza la tabla de ContactClientelicencias. Esto lo utilizan en los grupos de implementacion                                                                                                                             |
| `traza_clientelicencia_currentetapaid` | int(11)      | El clientelicencia_currentetapaid de trazabilidad relacionado a ese contacto                | Este dato lo actualiza trazabilidad, cada vez que se cambia de estado ahi, manda una request a whatrestaurant para actualizarlo, esto se hizo para unos filtros en el front actualmente comentados por rendimiento                                                                                                                                                      |

## Tablas secundarias

### TicketParticipantUsers

Esta tabla se creo para los grupos, muchas personas pueden participar en un grupo y pedir participaciones. Por eso los tickets grupales siempre se crean abiertos y las personas van marcando su participacion o pidiendo la participacion de otros

| Columna    | Tipo       | Descripción                        | Comentario |
| ---------- | ---------- | ---------------------------------- | ---------- |
| `userId`   | PK int(11) | El id del usuario participante     |            |
| `ticketId` | PK int(11) | El id del ticket al cual participa |            |

### GroupContacts

Esta tabla se creo para los grupos, para llevar un registro en la bd de que contactos participan en que grupos, esta tabla no se actualiza sola, se actualiza manualmente por una request al mismo whaticket o desde la vista de conexion, en los 3 puntos de cada conexion sale una opción

| Columna                | Tipo       | Descripción                      | Comentario |
| ---------------------- | ---------- | -------------------------------- | ---------- |
| `groupContactId`       | int(11)    | El id del contacto tipo grupo    |            |
| `participantContactId` | int(11)    | El id del contacto que participa |            |
| `whatsappId `          | PK int(11) | El id de la conexion del grupo   |            |

### SendMessageRequests

Tabla tipo log de registro de peticiones de envio de mensajes. Sistemas alternos usan whaticket para comuinicar cosas como resumen de asistencias, etc

### SequelizeMeta

Tabla que crea sequealize para registrar que migraciones ya se corrieron en la bd

### TicketHelpUsers

Tabla parecida a la de TicketParticipantUsers. Esta se usa para tickets individuales cuando piden ayuda a otros usuarios que no son el dueño del ticket

### WhatsappCountries

Tabla creada para el whatrestaurant comercial. pasa que ellos realizan envio de campañas y por el numero del contacto sacamos el pais y tenemos que enviarlo desde el numero comercial de ese pais y un wpp puede enviar a varios paises
